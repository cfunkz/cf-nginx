#!/bin/bash
# cf-nginx - Cloudflare IP manager for NGINX

set -e

source /usr/lib/cf-nginx/cf-ips.sh

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

SITES_DIR="/etc/nginx/sites-available"

print_header() {
    clear
    echo -e "${BLUE}╔════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║  cf-nginx - Cloudflare IP Manager     ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════╝${NC}"
}

show_menu() {
    echo ""
    echo -e "${YELLOW}Options:${NC}"
    echo "  1) Enable CF support for a site"
    echo "  2) Disable CF support for a site"
    echo "  3) Update all now (NGINX + UFW)"
    echo "  4) Show status"
    echo "  5) List CF IP ranges"
    echo "  6) UFW auto-update (enable/disable)"
    echo "  7) Exit"
    echo ""
    echo -n "Choose an option: "
}

show_status() {
    echo -e "${BLUE}════════════════════════════════════════${NC}"
    echo -e "${BLUE}Status${NC}"
    echo -e "${BLUE}════════════════════════════════════════${NC}"
    
    local site_count
    site_count=$(get_enabled_sites | wc -l)
    if [[ $site_count -gt 0 ]]; then
        echo -e "${GREEN}✓${NC} Enabled sites ($site_count):"
        while IFS= read -r site; do
            echo "  • $site"
        done < <(get_enabled_sites)
    else
        echo -e "${YELLOW}⚠${NC} No sites enabled"
    fi
    
    echo ""
    
    if is_ufw_autoupdate_enabled; then
        echo -e "${GREEN}✓${NC} UFW auto-update: ENABLED"
    else
        echo -e "${YELLOW}⊘${NC} UFW auto-update: DISABLED"
    fi
    
    echo ""
    
    if systemctl is-active --quiet cf-nginx.timer 2>/dev/null; then
        echo -e "${GREEN}✓${NC} Auto-update timer: ACTIVE"
    else
        echo -e "${RED}✗${NC} Auto-update timer: INACTIVE"
    fi
}

list_available_sites() {
    echo -e "${YELLOW}Available NGINX sites:${NC}"
    local count=0
    for site in "$SITES_DIR"/*; do
        [[ ! -f "$site" ]] && continue
        local sitename
        sitename=$(basename "$site")
        [[ "$sitename" == "default" ]] && continue
        local mark=""
        if is_enabled "$sitename"; then
            mark="${GREEN}[enabled]${NC}"
        fi
        echo -e "  • $sitename $mark"
        count=$((count + 1))
    done
    if [[ $count -eq 0 ]]; then
        echo "  (none)"
    fi
}

list_cf_ips() {
    echo -e "${YELLOW}Cloudflare IPv4 ranges:${NC}"
    get_ipv4_ranges
    echo ""
    echo -e "${YELLOW}Cloudflare IPv6 ranges:${NC}"
    get_ipv6_ranges
}

enable_site_interactive() {
    list_available_sites
    
    echo ""
    echo -n "Enter site name to enable: "
    read -r site_name || true
    
    if [[ -z "$site_name" ]]; then
        return 1
    fi
    
    if [[ ! -f "$SITES_DIR/$site_name" ]]; then
        echo -e "${RED}❌ Site not found: $site_name${NC}"
        return 1
    fi
    
    if is_enabled "$site_name"; then
        echo -e "${YELLOW}⚠️  Already enabled: $site_name${NC}"
        return 0
    fi
    
    echo ""
    echo -e "${BLUE}Enabling Cloudflare support for: $site_name${NC}"
    
    if grep -q "listen.*443.*ssl" "$SITES_DIR/$site_name" 2>/dev/null; then
        echo -e "${GREEN}✓ SSL configured${NC}"
    else
        echo -e "${YELLOW}⚠️  No SSL detected${NC}"
        echo -n "Enable Let's Encrypt SSL? (y/N): "
        read -r enable_ssl || true
        
        if [[ "$enable_ssl" =~ ^[Yy]$ ]]; then
            if command -v certbot &>/dev/null; then
                certbot --nginx -d "$site_name" || true
            else
                echo -e "${RED}❌ certbot not installed${NC}"
                echo "Install: apt-get install certbot python3-certbot-nginx"
                echo -n "Continue without SSL? (y/N): "
                read -r cont || true
                if [[ ! "$cont" =~ ^[Yy]$ ]]; then
                    return 1
                fi
            fi
        fi
    fi
    
    echo ""
    echo -e "${BLUE}Adding Cloudflare IP directives...${NC}"
    
    if update_nginx_site "$site_name"; then
        enable_site "$site_name"
        systemctl reload nginx 2>/dev/null || true
        echo -e "${GREEN}✅ Successfully enabled CF support for $site_name${NC}"
    else
        echo -e "${RED}❌ Failed to enable CF support${NC}"
        return 1
    fi
}

disable_site_interactive() {
    local enabled_count
    enabled_count=$(get_enabled_sites | wc -l)
    
    if [[ $enabled_count -eq 0 ]]; then
        echo -e "${YELLOW}⚠️  No sites enabled${NC}"
        return 1
    fi
    
    echo -e "${YELLOW}Enabled sites:${NC}"
    while IFS= read -r site; do
        echo "  • $site"
    done < <(get_enabled_sites)
    
    echo ""
    echo -n "Enter site name to disable: "
    read -r site_name || true
    
    if [[ -z "$site_name" ]]; then
        return 1
    fi
    
    if ! is_enabled "$site_name"; then
        echo -e "${YELLOW}⚠️  Not enabled: $site_name${NC}"
        return 1
    fi
    
    local config_file="$SITES_DIR/$site_name"
    
    if [[ -f "$config_file" ]]; then
        cp "$config_file" "${config_file}.bak-$(date +%s)"
        remove_cf_directives "$config_file"
        
        if nginx -t 2>/dev/null; then
            disable_site "$site_name"
            systemctl reload nginx 2>/dev/null || true
            echo -e "${GREEN}✅ Successfully disabled CF support for $site_name${NC}"
        else
            local latest_backup
            latest_backup=$(ls -t "${config_file}.bak-"* 2>/dev/null | head -1)
            [[ -n "$latest_backup" ]] && mv "$latest_backup" "$config_file"
            echo -e "${RED}❌ Failed, backup restored${NC}"
            return 1
        fi
    else
        disable_site "$site_name"
        echo -e "${GREEN}✅ Removed from enabled list${NC}"
    fi
}

update_now_interactive() {
    echo -e "${BLUE}Updating all Cloudflare IPs...${NC}"
    echo ""
    
    echo "Fetching latest CF IPs..."
    if fetch_cf_ips; then
        echo -e "${GREEN}✅ Fetched latest IPs${NC}"
    else
        echo -e "${RED}❌ Failed to fetch, using cache${NC}"
    fi
    
    echo ""
    echo "Updating NGINX sites..."
    update_all_nginx_sites
    
    echo ""
    
    if is_ufw_autoupdate_enabled; then
        echo "Updating UFW rules..."
        if sync_ufw; then
            echo -e "${GREEN}✅ UFW updated${NC}"
        else
            echo -e "${RED}❌ UFW update failed${NC}"
        fi
    else
        echo -e "${YELLOW}ℹ UFW auto-update disabled${NC}"
    fi
    
    echo ""
    echo -e "${GREEN}✅ Update complete${NC}"
}

ufw_autoupdate_menu() {
    echo ""
    echo -e "${BLUE}════════════════════════════════════════${NC}"
    echo -e "${BLUE}UFW Auto-Update Settings${NC}"
    echo -e "${BLUE}════════════════════════════════════════${NC}"
    echo ""
    
    if is_ufw_autoupdate_enabled; then
        echo -e "${GREEN}Status: ENABLED${NC}"
        echo ""
        echo -n "Disable UFW auto-update? (y/N): "
        read -r disable_ufw || true
        
        if [[ "$disable_ufw" =~ ^[Yy]$ ]]; then
            disable_ufw_autoupdate
            echo -e "${GREEN}✅ UFW auto-update disabled${NC}"
        fi
    else
        echo -e "${YELLOW}Status: DISABLED${NC}"
        echo ""
        echo -n "Enable UFW auto-update? (y/N): "
        read -r enable_ufw || true
        
        if [[ "$enable_ufw" =~ ^[Yy]$ ]]; then
            if ! command -v ufw &>/dev/null; then
                echo -e "${RED}❌ UFW not installed${NC}"
                return 1
            fi
            
            enable_ufw_autoupdate
            echo -e "${GREEN}✅ UFW auto-update enabled${NC}"
            echo ""
            echo "Running initial sync..."
            if sync_ufw; then
                echo -e "${GREEN}✅ UFW synced${NC}"
            fi
            
            echo ""
            echo -e "${YELLOW}⚠️  Don't forget:${NC}"
            echo "  1. ${BLUE}ufw allow 22/tcp${NC}"
            echo "  2. ${BLUE}ufw enable${NC}"
            echo "  3. ${BLUE}ufw default deny incoming${NC}"
        fi
    fi
}

main() {
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}❌ Must run as root${NC}"
        exit 1
    fi
    
    case "${1:-}" in
        status)
            show_status
            exit 0
            ;;
        update)
            fetch_cf_ips || true
            update_all_nginx_sites
            if is_ufw_autoupdate_enabled; then
                sync_ufw && echo "UFW updated" || true
            fi
            exit 0
            ;;
        enable)
            if [[ -z "${2:-}" ]]; then
                echo "Usage: cf-nginx enable <site>"
                exit 1
            fi
            site="$2"
            if [[ ! -f "$SITES_DIR/$site" ]]; then
                echo "Site not found: $site"
                exit 1
            fi
            if is_enabled "$site"; then
                echo "Already enabled: $site"
                exit 0
            fi
            if update_nginx_site "$site"; then
                enable_site "$site"
                systemctl reload nginx || true
                echo "✅ Enabled: $site"
            else
                echo "❌ Failed: $site"
                exit 1
            fi
            exit 0
            ;;
        disable)
            if [[ -z "${2:-}" ]]; then
                echo "Usage: cf-nginx disable <site>"
                exit 1
            fi
            site="$2"
            if [[ -f "$SITES_DIR/$site" ]]; then
                remove_cf_directives "$SITES_DIR/$site"
                nginx -t 2>/dev/null && systemctl reload nginx || true
            fi
            disable_site "$site"
            echo "✅ Disabled: $site"
            exit 0
            ;;
        list)
            list_cf_ips
            exit 0
            ;;
        ufw-enable)
            enable_ufw_autoupdate
            sync_ufw || true
            echo "✅ UFW auto-update enabled"
            exit 0
            ;;
        ufw-disable)
            disable_ufw_autoupdate
            echo "✅ UFW auto-update disabled"
            exit 0
            ;;
        help|--help|-h)
            echo "Usage: cf-nginx [command]"
            echo ""
            echo "Commands:"
            echo "  status       Show status"
            echo "  update       Update all (NGINX + UFW)"
            echo "  enable <s>   Enable CF for site"
            echo "  disable <s>  Disable CF for site"
            echo "  list         List CF IPs"
            echo "  ufw-enable   Enable UFW auto-update"
            echo "  ufw-disable  Disable UFW auto-update"
            exit 0
            ;;
    esac
    
    while true; do
        print_header
        show_menu
        read -r choice || true
        
        case $choice in
            1) enable_site_interactive || true ;;
            2) disable_site_interactive || true ;;
            3) update_now_interactive || true ;;
            4) show_status || true ;;
            5) list_cf_ips || true ;;
            6) ufw_autoupdate_menu || true ;;
            7) echo "Goodbye!" && exit 0 ;;
            *) echo -e "${RED}Invalid option${NC}" || true ;;
        esac
        
        echo ""
        echo -n "Press Enter to continue..."
        read -r || true
    done
}

main "$@"
