#!/bin/bash
# Cloudflare NGINX IP Manager - Interactive CLI

source /usr/lib/cf-nginx/cf-ips.sh

SITES_DIR="/etc/nginx/sites-available"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_header() {
    echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${BLUE}‚ïë  Cloudflare NGINX IP Manager          ‚ïë${NC}"
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
}

list_available_sites() {
    echo -e "${YELLOW}Available NGINX sites:${NC}"
    echo ""
    
    local i=1
    for site in "$SITES_DIR"/*; do
        if [[ -f "$site" && ! -L "$site" ]]; then
            local site_name=$(basename "$site")
            local status="‚ùå"
            
            if is_cf_enabled "$site_name"; then
                status="${GREEN}‚úÖ${NC}"
            fi
            
            echo -e "  [$i] $status $site_name"
            ((i++))
        fi
    done
    echo ""
}

enable_site_interactive() {
    list_available_sites
    
    echo -n "Enter site name to enable CF support: "
    read site_name
    
    if [[ ! -f "$SITES_DIR/$site_name" ]]; then
        echo -e "${RED}‚ùå Site not found: $site_name${NC}"
        return 1
    fi
    
    if is_cf_enabled "$site_name"; then
        echo -e "${YELLOW}‚ö†Ô∏è  CF support already enabled for $site_name${NC}"
        return 0
    fi
    
    echo ""
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo -e "${BLUE}Enabling Cloudflare support for: $site_name${NC}"
    echo -e "${BLUE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""
    
    # Check if site has SSL
    local has_ssl=0
    if grep -q "listen.*443.*ssl" "$SITES_DIR/$site_name" 2>/dev/null; then
        has_ssl=1
        echo -e "${GREEN}‚úì SSL already configured${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  No SSL detected${NC}"
        echo ""
        echo -n "Would you like to enable Let's Encrypt SSL first? (y/N): "
        read enable_ssl
        
        if [[ "$enable_ssl" =~ ^[Yy]$ ]]; then
            echo ""
            echo -e "${BLUE}Running certbot...${NC}"
            if command -v certbot &> /dev/null; then
                certbot --nginx -d "$site_name"
                
                if [[ $? -eq 0 ]]; then
                    echo -e "${GREEN}‚úÖ SSL certificate installed${NC}"
                    has_ssl=1
                else
                    echo -e "${RED}‚ùå SSL installation failed${NC}"
                    echo -n "Continue with CF setup anyway? (y/N): "
                    read continue_anyway
                    if [[ ! "$continue_anyway" =~ ^[Yy]$ ]]; then
                        return 1
                    fi
                fi
            else
                echo -e "${RED}‚ùå certbot not installed${NC}"
                echo "Install with: apt-get install certbot python3-certbot-nginx"
                echo -n "Continue without SSL? (y/N): "
                read continue_anyway
                if [[ ! "$continue_anyway" =~ ^[Yy]$ ]]; then
                    return 1
                fi
            fi
        fi
    fi
    
    echo ""
    echo -e "${BLUE}Adding Cloudflare IP directives...${NC}"
    
    # Generate CF directives
    local cf_directives=$(mktemp)
    echo "" > "$cf_directives"
    echo "    # BEGIN CLOUDFLARE IPS - DO NOT EDIT MANUALLY" >> "$cf_directives"
    generate_real_ip_directives >> "$cf_directives"
    echo "    # END CLOUDFLARE IPS" >> "$cf_directives"
    echo "" >> "$cf_directives"
    
    # Show what will be added
    echo ""
    echo -e "${YELLOW}These directives will be added after each server_name:${NC}"
    cat "$cf_directives"
    echo ""
    
    # Use manual insertion method (always reliable)
    local config_file="$SITES_DIR/$site_name"
    local temp_file=$(mktemp)
    
    awk -v cf_file="$cf_directives" '
    BEGIN {
        cf_content = ""
        while ((getline line < cf_file) > 0) {
            cf_content = cf_content line "\n"
        }
        close(cf_file)
        
        in_server = 0
        cf_inserted = 0
    }
    
    /^[[:space:]]*server[[:space:]]*{/ || /^[[:space:]]*server[[:space:]]*$/ {
        print
        in_server = 1
        cf_inserted = 0
        next
    }
    
    in_server && /server_name/ && !/managed by Certbot/ && !cf_inserted {
        print
        printf "%s", cf_content
        cf_inserted = 1
        next
    }
    
    in_server && /^[[:space:]]*}[[:space:]]*$/ {
        in_server = 0
        cf_inserted = 0
    }
    
    { print }
    ' "$config_file" > "$temp_file"
    
    rm -f "$cf_directives"
    
    # Backup and apply
    cp "$config_file" "${config_file}.bak-$(date +%s)"
    mv "$temp_file" "$config_file"
    
    # Test NGINX
    echo -e "${BLUE}Testing NGINX configuration...${NC}"
    if nginx -t 2>&1 | grep -q "successful"; then
        enable_site "$site_name"
        systemctl reload nginx
        echo ""
        echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        echo -e "${GREEN}‚úÖ Successfully enabled CF support for $site_name${NC}"
        echo -e "${GREEN}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
        
        if [[ $has_ssl -eq 1 ]]; then
            echo ""
            echo -e "${YELLOW}üìù Note:${NC} CF directives added to ALL server blocks (HTTP + HTTPS)"
        fi
    else
        echo -e "${RED}‚ùå NGINX config test failed, restoring backup${NC}"
        nginx -t 2>&1 | tail -5
        local latest_backup=$(ls -t "${config_file}.bak-"* 2>/dev/null | head -1)
        if [[ -n "$latest_backup" ]]; then
            mv "$latest_backup" "$config_file"
        fi
        echo ""
        echo -e "${YELLOW}üí° Tip: Complex configs may need manual review${NC}"
        echo "   Config: $config_file"
    fi
}

disable_site_interactive() {
    local enabled_sites=$(get_enabled_sites)
    
    if [[ -z "$enabled_sites" ]]; then
        echo -e "${YELLOW}No sites have CF support enabled${NC}"
        return 0
    fi
    
    echo -e "${YELLOW}Sites with CF support enabled:${NC}"
    echo ""
    
    local i=1
    while IFS= read -r site; do
        echo -e "  [$i] $site"
        ((i++))
    done <<< "$enabled_sites"
    echo ""
    
    echo -n "Enter site name to disable CF support: "
    read site_name
    
    if ! is_cf_enabled "$site_name"; then
        echo -e "${RED}‚ùå CF support not enabled for: $site_name${NC}"
        return 1
    fi
    
    echo ""
    echo -e "${BLUE}Disabling Cloudflare support for: $site_name${NC}"
    
    disable_site "$site_name"
    
    # Remove CF directives from config
    local config_file="$SITES_DIR/$site_name"
    if [[ -f "$config_file" ]]; then
        cp "$config_file" "${config_file}.bak-$(date +%s)"
        
        # Use the library function
        source /usr/lib/cf-nginx/cf-ips.sh
        remove_cf_directives "$config_file"
        
        if nginx -t 2>&1 | grep -q "successful"; then
            systemctl reload nginx
            echo -e "${GREEN}‚úÖ Successfully disabled CF support for $site_name${NC}"
        else
            echo -e "${RED}‚ùå NGINX config test failed${NC}"
            # Restore backup
            local latest_backup=$(ls -t "${config_file}.bak-"* 2>/dev/null | head -1)
            if [[ -n "$latest_backup" ]]; then
                mv "$latest_backup" "$config_file"
                echo -e "${YELLOW}‚ö†Ô∏è  Backup restored${NC}"
            fi
        fi
    fi
}

show_status() {
    echo -e "${YELLOW}Cloudflare IP Status:${NC}"
    echo ""
    
    if [[ -f "$IP_CACHE" ]]; then
        local ipv4_count=$(get_ipv4_ranges | wc -l)
        local ipv6_count=$(get_ipv6_ranges | wc -l)
        local cache_age=$(stat -c %Y "$IP_CACHE")
        local current_time=$(date +%s)
        local age_hours=$(( (current_time - cache_age) / 3600 ))
        
        echo -e "  IPv4 ranges: ${GREEN}$ipv4_count${NC}"
        echo -e "  IPv6 ranges: ${GREEN}$ipv6_count${NC}"
        echo -e "  Cache age: ${GREEN}$age_hours hours${NC}"
    else
        echo -e "  ${YELLOW}No IP cache found${NC}"
    fi
    
    echo ""
    echo -e "${YELLOW}Enabled sites:${NC}"
    
    local enabled_sites=$(get_enabled_sites)
    if [[ -z "$enabled_sites" ]]; then
        echo -e "  ${YELLOW}None${NC}"
    else
        while IFS= read -r site; do
            echo -e "  ${GREEN}‚úÖ${NC} $site"
        done <<< "$enabled_sites"
    fi
    
    echo ""
    echo -e "${YELLOW}Auto-update status:${NC}"
    if systemctl is-enabled cf-nginx.timer &>/dev/null; then
        echo -e "  ${GREEN}‚úÖ Enabled${NC}"
        local next_run=$(systemctl status cf-nginx.timer | grep "Trigger:" | cut -d';' -f2- || echo "Unknown")
        echo -e "  Next run: $next_run"
    else
        echo -e "  ${RED}‚ùå Disabled${NC}"
    fi
}

update_now() {
    echo -e "${BLUE}Checking for Cloudflare IP updates...${NC}"
    echo ""
    
    if check_for_updates; then
        update_all_sites
    else
        echo -e "${GREEN}No updates needed${NC}"
    fi
}

show_menu() {
    echo ""
    echo -e "${YELLOW}Options:${NC}"
    echo "  1) Enable CF support for a site"
    echo "  2) Disable CF support for a site"
    echo "  3) Update all enabled sites now"
    echo "  4) Show status"
    echo "  5) Check for CF IP updates"
    echo "  6) List CF IPs"
    echo "  7) Exit"
    echo ""
    echo -n "Choose an option: "
}

list_cf_ips() {
    echo -e "${YELLOW}Cloudflare IPv4 ranges:${NC}"
    get_ipv4_ranges
    echo ""
    echo -e "${YELLOW}Cloudflare IPv6 ranges:${NC}"
    get_ipv6_ranges
}

main() {
    # Check if running as root
    if [[ $EUID -ne 0 ]]; then
        echo -e "${RED}‚ùå This script must be run as root${NC}"
        exit 1
    fi
    
    print_header
    
    # Handle command line arguments
    case "${1:-}" in
        status)
            show_status
            exit 0
            ;;
        update)
            update_now
            exit 0
            ;;
        enable)
            if [[ -n "${2:-}" ]]; then
                local site="$2"
                
                if [[ ! -f "/etc/nginx/sites-available/$site" ]]; then
                    echo -e "${RED}‚ùå Site not found: $site${NC}"
                    exit 1
                fi
                
                if is_cf_enabled "$site"; then
                    echo -e "${YELLOW}‚ö†Ô∏è  CF support already enabled for $site${NC}"
                    exit 0
                fi
                
                # Check if SSL is configured
                local has_ssl=0
                if grep -q "listen.*443.*ssl" "/etc/nginx/sites-available/$site" 2>/dev/null; then
                    has_ssl=1
                    echo -e "${GREEN}‚úì SSL already configured${NC}"
                else
                    echo -e "${YELLOW}‚ö†Ô∏è  No SSL detected for $site${NC}"
                    echo -n "Enable Let's Encrypt SSL? (y/N): "
                    read enable_ssl
                    
                    if [[ "$enable_ssl" =~ ^[Yy]$ ]]; then
                        if command -v certbot &> /dev/null; then
                            echo -e "${BLUE}Running certbot...${NC}"
                            certbot --nginx -d "$site"
                            [[ $? -eq 0 ]] && has_ssl=1
                        else
                            echo -e "${RED}‚ùå certbot not installed${NC}"
                            echo "Install with: apt-get install certbot python3-certbot-nginx"
                            echo -n "Continue without SSL? (y/N): "
                            read continue_anyway
                            if [[ ! "$continue_anyway" =~ ^[Yy]$ ]]; then
                                exit 1
                            fi
                        fi
                    fi
                fi
                
                echo -e "${BLUE}Enabling Cloudflare support for $site...${NC}"
                
                # Generate CF directives
                local cf_directives=$(mktemp)
                echo "" > "$cf_directives"
                echo "    # BEGIN CLOUDFLARE IPS - DO NOT EDIT MANUALLY" >> "$cf_directives"
                generate_real_ip_directives >> "$cf_directives"
                echo "    # END CLOUDFLARE IPS" >> "$cf_directives"
                echo "" >> "$cf_directives"
                
                local config_file="/etc/nginx/sites-available/$site"
                local temp_file=$(mktemp)
                
                awk -v cf_file="$cf_directives" '
                BEGIN {
                    cf_content = ""
                    while ((getline line < cf_file) > 0) {
                        cf_content = cf_content line "\n"
                    }
                    close(cf_file)
                    in_server = 0
                    cf_inserted = 0
                }
                /^[[:space:]]*server[[:space:]]*{/ || /^[[:space:]]*server[[:space:]]*$/ {
                    print
                    in_server = 1
                    cf_inserted = 0
                    next
                }
                in_server && /server_name/ && !/managed by Certbot/ && !cf_inserted {
                    print
                    printf "%s", cf_content
                    cf_inserted = 1
                    next
                }
                in_server && /^[[:space:]]*}[[:space:]]*$/ {
                    in_server = 0
                    cf_inserted = 0
                }
                { print }
                ' "$config_file" > "$temp_file"
                
                rm -f "$cf_directives"
                cp "$config_file" "${config_file}.bak-$(date +%s)"
                mv "$temp_file" "$config_file"
                
                if nginx -t 2>&1 | grep -q "successful"; then
                    enable_site "$site"
                    systemctl reload nginx
                    echo -e "${GREEN}‚úÖ CF support enabled for $site${NC}"
                    [[ $has_ssl -eq 1 ]] && echo -e "${YELLOW}üìù CF directives added to all server blocks${NC}"
                else
                    echo -e "${RED}‚ùå NGINX config test failed, restoring backup${NC}"
                    local latest_backup=$(ls -t "${config_file}.bak-"* 2>/dev/null | head -1)
                    if [[ -n "$latest_backup" ]]; then
                        mv "$latest_backup" "$config_file"
                    fi
                    exit 1
                fi
            else
                echo -e "${RED}‚ùå Usage: cf-nginx enable <site-name>${NC}"
                exit 1
            fi
            exit 0
            ;;
        disable)
            if [[ -n "${2:-}" ]]; then
                local site="$2"
                disable_site "$site"
                
                local config_file="/etc/nginx/sites-available/$site"
                if [[ -f "$config_file" ]]; then
                    cp "$config_file" "${config_file}.bak-$(date +%s)"
                    remove_cf_directives "$config_file"
                    
                    if nginx -t 2>&1 | grep -q "successful"; then
                        systemctl reload nginx
                        echo -e "${GREEN}‚úÖ CF support disabled for $site${NC}"
                    else
                        echo -e "${RED}‚ùå NGINX config test failed, restoring backup${NC}"
                        local latest_backup=$(ls -t "${config_file}.bak-"* 2>/dev/null | head -1)
                        if [[ -n "$latest_backup" ]]; then
                            mv "$latest_backup" "$config_file"
                        fi
                    fi
                else
                    echo -e "${RED}‚ùå Config file not found: $config_file${NC}"
                fi
            else
                echo -e "${RED}‚ùå Usage: cf-nginx disable <site-name>${NC}"
                exit 1
            fi
            exit 0
            ;;
        list)
            list_cf_ips
            exit 0
            ;;
        help|--help|-h)
            echo "Usage: cf-nginx [command] [options]"
            echo ""
            echo "Commands:"
            echo "  status              Show status of CF IP integration"
            echo "  update              Update all enabled sites now"
            echo "  enable <site>       Enable CF support for a site"
            echo "  disable <site>      Disable CF support for a site"
            echo "  list                List all CF IP ranges"
            echo "  help                Show this help"
            echo ""
            echo "Interactive mode: Run without arguments"
            exit 0
            ;;
    esac
    
    # Interactive mode
    while true; do
        show_menu
        read choice
        
        case $choice in
            1)
                enable_site_interactive
                ;;
            2)
                disable_site_interactive
                ;;
            3)
                update_all_sites
                ;;
            4)
                show_status
                ;;
            5)
                update_now
                ;;
            6)
                list_cf_ips
                ;;
            7)
                echo -e "${GREEN}Goodbye!${NC}"
                exit 0
                ;;
            *)
                echo -e "${RED}‚ùå Invalid option${NC}"
                ;;
        esac
        
        echo ""
        echo -n "Press Enter to continue..."
        read
        clear
        print_header
    done
}

main "$@"
