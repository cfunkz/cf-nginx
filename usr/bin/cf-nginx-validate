#!/bin/bash
set -e
source /usr/lib/cf-nginx/cf-ips.sh

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

[[ $EUID -ne 0 ]] && echo -e "${RED}❌ Must run as root${NC}" && exit 1
[[ -z "$1" ]] && echo "Usage: cf-nginx-validate <site>" && exit 1

SITE="$1"
CONFIG="/etc/nginx/sites-available/$SITE"

[[ ! -f "$CONFIG" ]] && echo -e "${RED}❌ Config not found${NC}" && exit 1

echo -e "${BLUE}Validating: $SITE${NC}"
echo ""

server_count=$(grep -c "^server {" "$CONFIG" 2>/dev/null || echo "0")
cf_count=$(grep -c "BEGIN CLOUDFLARE IPS" "$CONFIG" 2>/dev/null || echo "0")

echo "Server blocks: $server_count"
echo "CF blocks: $cf_count"

if [[ $server_count -eq $cf_count ]] && [[ $cf_count -gt 0 ]]; then
    echo -e "${GREEN}✅ All server blocks have CF directives${NC}"
elif [[ $cf_count -eq 0 ]]; then
    echo -e "${YELLOW}⚠️  No CF directives${NC}"
else
    echo -e "${RED}⚠️  Mismatch${NC}"
fi

if nginx -t 2>/dev/null; then
    echo -e "${GREEN}✅ NGINX config valid${NC}"
else
    echo -e "${RED}❌ NGINX errors${NC}"
fi

if is_enabled "$SITE"; then
    echo -e "${GREEN}✅ Site enabled for auto-updates${NC}"
else
    echo -e "${YELLOW}⚠️  Not enabled${NC}"
fi
